<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Cubicaci√≥n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 20px auto;
      padding: 10px 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
      margin-bottom: 20px;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px 14px;
    }
    label {
      display: block;
      margin-top: 6px;
      font-size: 0.9rem;
    }
    input, select {
      width: 100%;
      padding: 4px 6px;
      margin-top: 2px;
      box-sizing: border-box;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      cursor: pointer;
    }
    .resultado {
      white-space: pre-wrap;
      font-family: Consolas, monospace;
      margin-top: 8px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fafafa;
    }
    .small {
      font-size: 0.8rem;
      color: #555;
    }
    .status-ok {
      color: #0a7a0a;
      font-weight: bold;
    }
    .status-bad {
      color: #b00020;
      font-weight: bold;
    }
    #container-box {
      border: 1px solid #999;
      margin-top: 16px;
      padding: 6px;
      background: #e9e9e9;
    }
    #container-title {
      font-size: 0.95rem;
      font-weight: bold;
      margin-bottom: 4px;
    }
    #vista3d-wrapper {
      background: #dcdcdc;
      padding: 8px;
    }
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1>Calculadora de Cubicaci√≥n</h1>
  <p class="small">
    Basado en tu Excel: tipos de camiones, tipos de pallet y c√°lculo de m√°ximo
    de pallet por cami√≥n (rejilla vs volumen). Incluye cantidad deseada y
    vista 3D tipo contenedor.
  </p>

  <div class="grid">
    <!-- CAMI√ìN -->
    <div class="card">
      <h2>Cami√≥n / Contenedor</h2>

      <label>Tipo de cami√≥n
        <select id="truckSelect">
          <option value="hino916">Hino 916</option>
          <option value="atego1729">Mercedes-Benz Atego 1729</option>
          <option value="volvofl240" selected>Volvo FL 240</option>
        </select>
      </label>

      <label>Largo (m)
        <input id="truckLargo" type="number" step="0.01" />
      </label>

      <label>Ancho (m)
        <input id="truckAncho" type="number" step="0.01" />
      </label>

      <label>Alto interno (m)
        <input id="truckAlto" type="number" step="0.01" />
      </label>

      <label>Capacidad (kg)
        <input id="truckCapacidad" type="number" step="1" />
      </label>

      <label>Valor viaje (CLP)
        <input id="valorViaje" type="number" step="1000" value="95000" />
      </label>
    </div>

    <!-- PALLET -->
    <div class="card">
      <h2>Pallet</h2>

      <label>Tipo de pallet
        <select id="palletSelect">
          <option value="eu">Pallet Europeo (1.2 √ó 0.8)</option>
          <option value="us" selected>Pallet Americano (1.2 √ó 1.0)</option>
        </select>
      </label>

      <label>Largo pallet (m)
        <input id="palLargo" type="number" step="0.01" />
      </label>

      <label>Ancho pallet (m)
        <input id="palAncho" type="number" step="0.01" />
      </label>

      <label>Alto pallet (m)
        <input id="palAlto" type="number" step="0.01" value="0.7" />
      </label>

      <label>Cantidad de pallets que quiero cargar
        <input id="palDeseados" type="number" step="1" value="0" />
      </label>

      <div class="small">
        * Si dejas la cantidad en 0, se muestra s√≥lo la capacidad m√°xima del cami√≥n.
      </div>
    </div>
  </div>

  <button onclick="calcular()">Calcular cubicaci√≥n</button>

  <div id="mensaje" class="small" style="margin-top:8px;"></div>
  <div id="salida" class="resultado"></div>

  <div id="container-box">
    <div id="container-title">Container / Cami√≥n ‚Äì Vista 3D</div>
    <div id="vista3d-wrapper">
      <!-- aqu√≠ se insertar√° el canvas de Three.js -->
      <div id="vista3d"></div>
    </div>
    <p class="small">
      L√≠nea roja = contenedor / caja del cami√≥n. Bloques verdes = pallets cargados.
      Bloques gris claro = espacios disponibles hasta completar la capacidad m√°xima.
    </p>
  </div>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r160/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r160/examples/js/controls/OrbitControls.js"></script>

  <script>
    // === Datos base (como en tu Excel) ===
    const trucks = {
      hino916: { nombre: "Hino 916", largo: 5.4, ancho: 2.2, alto: 2.1, capacidad: 3800 },
      atego1729: { nombre: "Mercedes-Benz Atego 1729", largo: 7.3, ancho: 2.4, alto: 2.3, capacidad: 11500 },
      volvofl240: { nombre: "Volvo FL 240", largo: 6.2, ancho: 2.3, alto: 2.2, capacidad: 6800 }
    };

    const pallets = {
      eu: { nombre: "Pallet Europeo", largo: 1.2, ancho: 0.8 },
      us: { nombre: "Pallet Americano", largo: 1.2, ancho: 1.0 }
    };

    // === Inicializaci√≥n de formulario ===
    window.addEventListener("load", () => {
      actualizarCamion();
      actualizarPallet();
      calcular();
    });

    document.getElementById("truckSelect").addEventListener("change", () => {
      actualizarCamion();
      calcular();
    });
    document.getElementById("palletSelect").addEventListener("change", () => {
      actualizarPallet();
      calcular();
    });

    function actualizarCamion() {
      const sel = document.getElementById("truckSelect").value;
      const t = trucks[sel];
      truckLargo.value = t.largo;
      truckAncho.value = t.ancho;
      truckAlto.value = t.alto;
      truckCapacidad.value = t.capacidad;
    }

    function actualizarPallet() {
      const sel = document.getElementById("palletSelect").value;
      const p = pallets[sel];
      palLargo.value = p.largo;
      palAncho.value = p.ancho;
    }

    // === C√°lculo principal ===
    function calcular() {
      const Lc = parseFloat(truckLargo.value);
      const Ac = parseFloat(truckAncho.value);
      const Hc = parseFloat(truckAlto.value);
      const capacidadKg = parseFloat(truckCapacidad.value) || 0;
      const valorViaje = parseFloat(valorViajeInput.value) || 0;

      const Lp = parseFloat(palLargo.value);
      const Ap = parseFloat(palAncho.value);
      const Hp = parseFloat(palAlto.value);
      const deseados = parseInt(palDeseados.value, 10) || 0;

      if (!Lc || !Ac || !Hc || !Lp || !Ap || !Hp) {
        salida.innerText = "Faltan datos. Revisa que todas las medidas tengan un valor v√°lido.";
        return;
      }

      const volPallet = Lp * Ap * Hp;
      const volCamion = Lc * Ac * Hc;

      const palletsAncho = Math.floor(Ac / Ap);
      const palletsLargo = Math.floor(Lc / Lp);
      const palletsAlto = Math.floor(Hc / Hp);

      const palletsRejilla = palletsAncho * palletsLargo * palletsAlto;
      const maxPorVolumen = Math.floor(volCamion / volPallet);

      let maximo = Math.min(maxPorVolumen, palletsRejilla);
      if (maximo === 0) maximo = 1;

      const valorPorM3 = volCamion > 0 ? valorViaje / volCamion : 0;

      let mensajeTexto = "";
      if (deseados <= 0) {
        mensajeTexto = "No ingresaste cantidad de pallets, se muestra solo la capacidad m√°xima del cami√≥n.";
      } else if (deseados <= maximo) {
        mensajeTexto = `üëâ Los ${deseados} pallets que quieres C A B E N en este cami√≥n (m√°ximo permitido: ${maximo}).`;
      } else {
        mensajeTexto = `‚ö† Los ${deseados} pallets que quieres NO CABEN. Capacidad m√°xima de este cami√≥n: ${maximo}.`;
      }

      mensaje.textContent = mensajeTexto;
      mensaje.className =
        deseados === 0
          ? "small"
          : deseados <= maximo
          ? "small status-ok"
          : "small status-bad";

      const texto = [
        `Cami√≥n: ${Lc.toFixed(2)}m (L) x ${Ac.toFixed(2)}m (A) x ${Hc.toFixed(2)}m (H)`,
        `Pallet: ${Lp.toFixed(2)}m (L) x ${Ap.toFixed(2)}m (A) x ${Hp.toFixed(2)}m (H)`,
        "",
        `Volumen pallet: ${volPallet.toFixed(3)} m¬≥`,
        `Volumen cami√≥n: ${volCamion.toFixed(3)} m¬≥`,
        "",
        `Pallets por ancho:  ${palletsAncho}`,
        `Pallets por largo:  ${palletsLargo}`,
        `Pallets por alto:   ${palletsAlto}`,
        `Pallets en rejilla (ancho √ó largo √ó alto): ${palletsRejilla}`,
        `M√°x. por volumen (INT(volCamion/volPallet)): ${maxPorVolumen}`,
        "",
        `M√ÅXIMO DE PALLET POR CAMI√ìN: ${maximo}`,
        deseados > 0 ? `Pallets deseados: ${deseados}` : "",
        "",
        `Capacidad de carga (kg): ${capacidadKg.toFixed(0)}`,
        `Valor viaje: ${valorViaje.toFixed(0)} CLP`,
        `Valor por m¬≥: ${valorPorM3.toFixed(0)} CLP/m¬≥`
      ].join("\n");

      salida.innerText = texto;

      // Pasamos datos al dibujo 3D
      const cols = palletsLargo;
      const rows = palletsAncho;
      const niveles = Math.max(palletsAlto, 1);
      dibujar3D(cols, rows, niveles, maximo, deseados);
    }

    // alias para inputs
    const truckLargo = document.getElementById("truckLargo");
    const truckAncho = document.getElementById("truckAncho");
    const truckAlto = document.getElementById("truckAlto");
    const truckCapacidad = document.getElementById("truckCapacidad");
    const valorViajeInput = document.getElementById("valorViaje");
    const palLargo = document.getElementById("palLargo");
    const palAncho = document.getElementById("palAncho");
    const palAlto = document.getElementById("palAlto");
    const palDeseados = document.getElementById("palDeseados");
    const salida = document.getElementById("salida");
    const mensaje = document.getElementById("mensaje");

    // === DIBUJO 3D ESTILO PIER2PIER (Three.js) ===
    let scene, camera, renderer, controls;

    function dibujar3D(cols, rows, niveles, maximo, deseados) {
      const usados = deseados > 0 ? Math.min(deseados, maximo) : maximo;

      const palletW = 1;
      const palletD = 1;
      const palletH = 0.6;
      const separacion = 0.1;

      const width = 700;
      const height = 360;

      if (!renderer) {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe0e0e0);

        camera = new THREE.PerspectiveCamera(35, width / height, 0.1, 1000);
        camera.position.set(12, 8, 18);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);

        const cont = document.getElementById("vista3d");
        cont.innerHTML = "";
        cont.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.12;
        controls.target.set(4, 0, 2);
        controls.update();
      }

      // Limpiar escena
      while (scene.children.length > 0) {
        scene.remove(scene.children[0]);
      }

      // Luces suaves
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(10, 15, 8);
      scene.add(dir);
      scene.add(new THREE.AmbientLight(0xffffff, 0.4));

      // Pallets
      const total = maximo;
      const layerSize = cols * rows;
      const totalADibujar = Math.min(total, cols * rows * niveles);

      for (let idx = 0; idx < totalADibujar; idx++) {
        const z = Math.floor(idx / layerSize);
        const resto = idx % layerSize;
        const y = Math.floor(resto / cols);
        const x = resto % cols;

        const ocupado = idx < usados;
        const color = ocupado ? 0x1b5e20 : 0xb0c4b0; // verde oscuro / gris verdoso

        const geo = new THREE.BoxGeometry(palletW, palletH, palletD);
        const mat = new THREE.MeshStandardMaterial({ color });
        const pallet = new THREE.Mesh(geo, mat);

        pallet.position.set(
          x * (palletW + separacion),
          z * (palletH + separacion) + palletH / 2,
          y * (palletD + separacion)
        );

        scene.add(pallet);
      }

      // Caja contenedor tipo wireframe rojo
      const contLargo = cols * (palletW + separacion);
      const contAlto = niveles * (palletH + separacion) + 0.5;
      const contAncho = rows * (palletD + separacion);

      const contGeo = new THREE.BoxGeometry(contLargo, contAlto, contAncho);
      const contMat = new THREE.MeshBasicMaterial({
        color: 0xcc0000,
        wireframe: true,
        transparent: true,
        opacity: 0.9
      });
      const contMesh = new THREE.Mesh(contGeo, contMat);
      contMesh.position.set(
        contLargo / 2 - (palletW + separacion) / 2,
        contAlto / 2,
        contAncho / 2 - (palletD + separacion) / 2
      );
      scene.add(contMesh);

      // Peque√±o piso gris claro
      const planeGeo = new THREE.PlaneGeometry(contLargo + 2, contAncho + 2);
      const planeMat = new THREE.MeshBasicMaterial({
        color: 0xd0d0d0,
        side: THREE.DoubleSide
      });
      const plane = new THREE.Mesh(planeGeo, planeMat);
      plane.rotation.x = -Math.PI / 2;
      plane.position.set(contMesh.position.x, 0, contMesh.position.z);
      scene.add(plane);

      // Animaci√≥n
      function animar() {
        requestAnimationFrame(animar);
        controls.update();
        renderer.render(scene, camera);
      }
      animar();
    }
  </script>
</body>
</html>

